#!/bin/bash

# Trojan-gRPC è½¬å‘å™¨ ç®¡ç†è„šæœ¬
# ä½¿ç”¨æ–¹æ³•: gopf

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
PURPLE='\033[0;35m'
NC='\033[0m'

# é…ç½®å˜é‡
SERVICE_NAME="gopf"
SERVICE_USER="gopf"
INSTALL_DIR="/opt/gopf"
CONFIG_DIR="/etc/gopf"
LOG_DIR="/var/log/gopf"

# æ£€æŸ¥æ˜¯å¦ä¸º root ç”¨æˆ·
check_root() {
    if [ "$EUID" -ne 0 ]; then
        echo -e "${RED}âŒ éœ€è¦ root æƒé™æ‰§è¡Œæ­¤æ“ä½œ${NC}"
        echo -e "${YELLOW}è¯·ä½¿ç”¨: sudo gopf${NC}"
        exit 1
    fi
}

# è·å–æœåŠ¡çŠ¶æ€
get_service_status() {
    if systemctl is-active --quiet $SERVICE_NAME 2>/dev/null; then
        echo -e "${GREEN}â—${NC} è¿è¡Œä¸­"
    elif systemctl is-enabled --quiet $SERVICE_NAME 2>/dev/null; then
        echo -e "${RED}â—${NC} å·²åœæ­¢"
    else
        echo -e "${YELLOW}â—${NC} æœªå®‰è£…"
    fi
}

# è·å–æœåŠ¡è¯¦ç»†ä¿¡æ¯
get_service_info() {
    if systemctl list-unit-files | grep -q "^$SERVICE_NAME.service"; then
        local status=$(systemctl is-active $SERVICE_NAME 2>/dev/null || echo "inactive")
        local enabled=$(systemctl is-enabled $SERVICE_NAME 2>/dev/null || echo "disabled")
        local uptime=""
        
        if [ "$status" = "active" ]; then
            uptime=$(systemctl show $SERVICE_NAME --property=ActiveEnterTimestamp --value 2>/dev/null)
            if [ -n "$uptime" ]; then
                uptime=" (å¯åŠ¨äº: $(date -d "$uptime" '+%Y-%m-%d %H:%M:%S' 2>/dev/null || echo "æœªçŸ¥"))"
            fi
        fi
        
        echo -e "${WHITE}çŠ¶æ€: ${NC}$status$uptime"
        echo -e "${WHITE}å¼€æœºå¯åŠ¨: ${NC}$enabled"
        
        if [ -f "$CONFIG_DIR/config.json" ]; then
            echo -e "${WHITE}é…ç½®æ–‡ä»¶: ${GREEN}å­˜åœ¨${NC}"
        else
            echo -e "${WHITE}é…ç½®æ–‡ä»¶: ${RED}ç¼ºå¤±${NC}"
        fi
        
        if [ -f "$INSTALL_DIR/grpc-forwarder" ]; then
            echo -e "${WHITE}ç¨‹åºæ–‡ä»¶: ${GREEN}å­˜åœ¨${NC}"
        else
            echo -e "${WHITE}ç¨‹åºæ–‡ä»¶: ${RED}ç¼ºå¤±${NC}"
        fi
    else
        echo -e "${RED}æœåŠ¡æœªå®‰è£…${NC}"
    fi
}

# æ˜¾ç¤ºä¸»èœå•
show_menu() {
    clear
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘        Trojan-gRPC è½¬å‘å™¨ ç®¡ç†       â•‘${NC}"
    echo -e "${CYAN}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${NC}"
    echo -e "${CYAN}â•‘${NC} æœåŠ¡çŠ¶æ€: $(get_service_status)                    ${CYAN}â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${WHITE}è¯·é€‰æ‹©æ“ä½œ:${NC}"
    echo ""
    echo -e "  ${GREEN}1)${NC} ğŸš€ å¯åŠ¨æœåŠ¡"
    echo -e "  ${RED}2)${NC} ğŸ›‘ åœæ­¢æœåŠ¡"
    echo -e "  ${YELLOW}3)${NC} ğŸ”„ é‡å¯æœåŠ¡"
    echo -e "  ${BLUE}4)${NC} ğŸ“Š æŸ¥çœ‹çŠ¶æ€"
    echo -e "  ${CYAN}5)${NC} ğŸ“‹ æŸ¥çœ‹æ—¥å¿—"
    echo -e "  ${PURPLE}6)${NC} âš™ï¸  ç¼–è¾‘é…ç½®"
    echo -e "  ${WHITE}7)${NC} ğŸ”§ æœåŠ¡ç®¡ç†"
    echo -e "  ${RED}8)${NC} ğŸ—‘ï¸  å¸è½½æœåŠ¡"
    echo -e "  ${WHITE}0)${NC} ğŸšª é€€å‡º"
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

# å¯åŠ¨æœåŠ¡
start_service() {
    check_root
    echo -e "${YELLOW}ğŸš€ æ­£åœ¨å¯åŠ¨æœåŠ¡...${NC}"
    if systemctl start $SERVICE_NAME; then
        sleep 2
        if systemctl is-active --quiet $SERVICE_NAME; then
            echo -e "${GREEN}âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ${NC}"
        else
            echo -e "${RED}âŒ æœåŠ¡å¯åŠ¨å¤±è´¥${NC}"
            echo -e "${YELLOW}æŸ¥çœ‹é”™è¯¯æ—¥å¿—: journalctl -u $SERVICE_NAME --no-pager -n 20${NC}"
        fi
    else
        echo -e "${RED}âŒ æœåŠ¡å¯åŠ¨å¤±è´¥${NC}"
    fi
    read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
}

# åœæ­¢æœåŠ¡
stop_service() {
    check_root
    echo -e "${YELLOW}ğŸ›‘ æ­£åœ¨åœæ­¢æœåŠ¡...${NC}"
    if systemctl stop $SERVICE_NAME; then
        echo -e "${GREEN}âœ… æœåŠ¡å·²åœæ­¢${NC}"
    else
        echo -e "${RED}âŒ æœåŠ¡åœæ­¢å¤±è´¥${NC}"
    fi
    read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
}

# é‡å¯æœåŠ¡
restart_service() {
    check_root
    echo -e "${YELLOW}ğŸ”„ æ­£åœ¨é‡å¯æœåŠ¡...${NC}"
    if systemctl restart $SERVICE_NAME; then
        sleep 2
        if systemctl is-active --quiet $SERVICE_NAME; then
            echo -e "${GREEN}âœ… æœåŠ¡é‡å¯æˆåŠŸ${NC}"
        else
            echo -e "${RED}âŒ æœåŠ¡é‡å¯å¤±è´¥${NC}"
            echo -e "${YELLOW}æŸ¥çœ‹é”™è¯¯æ—¥å¿—: journalctl -u $SERVICE_NAME --no-pager -n 20${NC}"
        fi
    else
        echo -e "${RED}âŒ æœåŠ¡é‡å¯å¤±è´¥${NC}"
    fi
    read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
}

# æŸ¥çœ‹çŠ¶æ€
show_status() {
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${WHITE}ğŸ“Š æœåŠ¡è¯¦ç»†çŠ¶æ€${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    get_service_info
    echo ""
    if systemctl list-unit-files | grep -q "^$SERVICE_NAME.service"; then
        echo -e "${WHITE}systemctl çŠ¶æ€:${NC}"
        systemctl status $SERVICE_NAME --no-pager -l
    fi
    echo ""
    read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
}

# æŸ¥çœ‹æ—¥å¿—
show_logs() {
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${WHITE}ğŸ“‹ æœåŠ¡æ—¥å¿— (æœ€è¿‘50è¡Œ)${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${YELLOW}1)${NC} æŸ¥çœ‹æœ€è¿‘æ—¥å¿—"
    echo -e "${YELLOW}2)${NC} å®æ—¶è·Ÿè¸ªæ—¥å¿—"
    echo -e "${YELLOW}3)${NC} æŸ¥çœ‹é”™è¯¯æ—¥å¿—"
    echo -e "${YELLOW}0)${NC} è¿”å›ä¸»èœå•"
    echo ""
    read -p "è¯·é€‰æ‹©: " log_choice
    
    case $log_choice in
        1)
            echo -e "${CYAN}æœ€è¿‘50è¡Œæ—¥å¿—:${NC}"
            journalctl -u $SERVICE_NAME --no-pager -n 50
            ;;
        2)
            echo -e "${CYAN}å®æ—¶æ—¥å¿— (æŒ‰ Ctrl+C é€€å‡º):${NC}"
            journalctl -u $SERVICE_NAME -f
            ;;
        3)
            echo -e "${CYAN}é”™è¯¯æ—¥å¿—:${NC}"
            journalctl -u $SERVICE_NAME --no-pager -p err
            ;;
        0)
            return
            ;;
        *)
            echo -e "${RED}æ— æ•ˆé€‰æ‹©${NC}"
            ;;
    esac
    echo ""
    read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
}

# ç¼–è¾‘é…ç½®
edit_config() {
    check_root
    if [ ! -f "$CONFIG_DIR/config.json" ]; then
        echo -e "${RED}âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_DIR/config.json${NC}"
        read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
        return
    fi
    
    echo -e "${YELLOW}ğŸ“ ç¼–è¾‘é…ç½®æ–‡ä»¶...${NC}"
    echo -e "${WHITE}é…ç½®æ–‡ä»¶è·¯å¾„: $CONFIG_DIR/config.json${NC}"
    echo ""
    
    if command -v nano &> /dev/null; then
        nano "$CONFIG_DIR/config.json"
    elif command -v vim &> /dev/null; then
        vim "$CONFIG_DIR/config.json"
    elif command -v vi &> /dev/null; then
        vi "$CONFIG_DIR/config.json"
    else
        echo -e "${RED}âŒ æœªæ‰¾åˆ°æ–‡æœ¬ç¼–è¾‘å™¨ (nano/vim/vi)${NC}"
        read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
        return
    fi
    
    echo ""
    read -p "é…ç½®å·²ä¿å­˜ï¼Œæ˜¯å¦é‡å¯æœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆ? (y/N): " restart_confirm
    if [[ $restart_confirm =~ ^[Yy]$ ]]; then
        restart_service
    fi
}

# æœåŠ¡ç®¡ç†
service_management() {
    check_root
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${WHITE}ğŸ”§ æœåŠ¡ç®¡ç†${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${YELLOW}1)${NC} å¯ç”¨å¼€æœºè‡ªå¯"
    echo -e "${YELLOW}2)${NC} ç¦ç”¨å¼€æœºè‡ªå¯"
    echo -e "${YELLOW}3)${NC} é‡è½½æœåŠ¡é…ç½®"
    echo -e "${YELLOW}4)${NC} æŸ¥çœ‹æœåŠ¡æ–‡ä»¶"
    echo -e "${YELLOW}0)${NC} è¿”å›ä¸»èœå•"
    echo ""
    read -p "è¯·é€‰æ‹©: " mgmt_choice
    
    case $mgmt_choice in
        1)
            if systemctl enable $SERVICE_NAME; then
                echo -e "${GREEN}âœ… å·²å¯ç”¨å¼€æœºè‡ªå¯${NC}"
            else
                echo -e "${RED}âŒ å¯ç”¨å¼€æœºè‡ªå¯å¤±è´¥${NC}"
            fi
            ;;
        2)
            if systemctl disable $SERVICE_NAME; then
                echo -e "${GREEN}âœ… å·²ç¦ç”¨å¼€æœºè‡ªå¯${NC}"
            else
                echo -e "${RED}âŒ ç¦ç”¨å¼€æœºè‡ªå¯å¤±è´¥${NC}"
            fi
            ;;
        3)
            if systemctl daemon-reload; then
                echo -e "${GREEN}âœ… æœåŠ¡é…ç½®å·²é‡è½½${NC}"
            else
                echo -e "${RED}âŒ é‡è½½æœåŠ¡é…ç½®å¤±è´¥${NC}"
            fi
            ;;
        4)
            echo -e "${CYAN}æœåŠ¡æ–‡ä»¶å†…å®¹:${NC}"
            cat /etc/systemd/system/$SERVICE_NAME.service
            ;;
        0)
            return
            ;;
        *)
            echo -e "${RED}æ— æ•ˆé€‰æ‹©${NC}"
            ;;
    esac
    echo ""
    read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
}

# å¸è½½æœåŠ¡
uninstall_service() {
    check_root
    echo -e "${RED}âš ï¸  è­¦å‘Š: è¿™å°†å®Œå…¨å¸è½½ Trojan-gRPC è½¬å‘å™¨${NC}"
    echo -e "${YELLOW}åŒ…æ‹¬: æœåŠ¡ã€é…ç½®æ–‡ä»¶ã€ç¨‹åºæ–‡ä»¶å’Œæ—¥å¿—${NC}"
    echo ""
    read -p "ç¡®è®¤å¸è½½? (è¾“å…¥ 'YES' ç¡®è®¤): " confirm
    
    if [ "$confirm" != "YES" ]; then
        echo -e "${YELLOW}âŒ å–æ¶ˆå¸è½½${NC}"
        read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
        return
    fi
    
    echo -e "${YELLOW}ğŸ—‘ï¸  æ­£åœ¨å¸è½½...${NC}"
    
    # åœæ­¢å¹¶ç¦ç”¨æœåŠ¡
    systemctl stop $SERVICE_NAME 2>/dev/null || true
    systemctl disable $SERVICE_NAME 2>/dev/null || true
    
    # åˆ é™¤æœåŠ¡æ–‡ä»¶
    rm -f /etc/systemd/system/$SERVICE_NAME.service
    systemctl daemon-reload
    
    # åˆ é™¤ç¨‹åºæ–‡ä»¶
    rm -rf $INSTALL_DIR
    rm -rf $CONFIG_DIR
    rm -rf $LOG_DIR
    
    # åˆ é™¤ç”¨æˆ·
    userdel $SERVICE_USER 2>/dev/null || true
    
    # åˆ é™¤ç®¡ç†è„šæœ¬
    rm -f /usr/local/bin/gopf
    
    echo -e "${GREEN}âœ… å¸è½½å®Œæˆ${NC}"
    echo -e "${YELLOW}ğŸ’¡ å¦‚éœ€é‡æ–°å®‰è£…ï¼Œè¯·è¿è¡Œ:${NC}"
    echo -e "${WHITE}curl -fsSL https://raw.githubusercontent.com/wanglao888/gopf/main/install.sh | bash${NC}"
    echo ""
    read -p "æŒ‰å›è½¦é”®é€€å‡º..."
    exit 0
}

# ä¸»å¾ªç¯
main() {
    while true; do
        show_menu
        read -p "è¯·é€‰æ‹© (0-8): " choice
        
        case $choice in
            1)
                start_service
                ;;
            2)
                stop_service
                ;;
            3)
                restart_service
                ;;
            4)
                show_status
                ;;
            5)
                show_logs
                ;;
            6)
                edit_config
                ;;
            7)
                service_management
                ;;
            8)
                uninstall_service
                ;;
            0)
                echo -e "${GREEN}ğŸ‘‹ å†è§ï¼${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}âŒ æ— æ•ˆé€‰æ‹©ï¼Œè¯·è¾“å…¥ 0-8${NC}"
                sleep 1
                ;;
        esac
    done
}

# è¿è¡Œä¸»ç¨‹åº
main
